<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<title>Controle de Ganhos</title>
		<meta name="theme-color" content="#3b82f6">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
			:root{
			--bg:#0f172a;--card:#111827;--primary:#3b82f6;--secondary:#9ca3af;
			--border:#1f2933;--text:#e5e7eb;--success:#22c55e;--danger:#ef4444;
			}
			body{font-family:Segoe UI;background:var(--bg);color:var(--text);margin:0;padding:30px}
			.container{max-width:1200px;margin:auto}
			h1,h3{text-align:center}
			.card{background:var(--card);border-radius:12px;padding:20px;margin-bottom:25px;box-shadow:0 10px 25px rgba(0,0,0,.4)}
			.header{display:flex;justify-content:space-between}
			select,input{background:#020617;color:var(--text);border:1px solid var(--border);padding:8px;border-radius:6px;width:100%}
			.tabs{display:flex;margin-top:15px}
			.tab{padding:10px 18px;cursor:pointer;background:#020617;margin-right:6px;border-radius:8px 8px 0 0;color:var(--secondary)}
			.tab.active{background:var(--primary);color:#fff;font-weight:bold}
			.content{display:none}
			.content.active{display:block}
			table{width:100%;border-collapse:collapse;margin-top:15px}
			th,td{border:1px solid var(--border);padding:8px;text-align:center}
			th{background:#020617}
			.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
			.resumo div{background:#020617;padding:18px;border-radius:10px;text-align:center}
			.valor{font-size:22px;font-weight:bold;margin-top:8px}
			.positivo{color:var(--success)} .negativo{color:var(--danger)}
			.mes-atual td{outline:2px solid var(--primary)}
			.heat-0{background:#020617}
			.heat-1{background:rgba(34,197,94,.15)}
			.heat-2{background:rgba(34,197,94,.25)}
			.heat-3{background:rgba(34,197,94,.35)}
			.heat-4{
			background:rgba(34,197,94,.45);
			color:#e5e7eb;
			font-weight:600;
			}
			.badge{font-size:11px;padding:4px 6px;border-radius:6px}
			.melhor{background:var(--success);color:#000}
			.pior{background:var(--danger)}
			.toast{
			position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
			background:#020617;border:1px solid var(--border);
			padding:10px 20px;border-radius:8px;opacity:0;transition:.3s
			}
			.toast.show{opacity:1}
			.assinatura{position:fixed;bottom:18px;right:22px;font-size:13px}
			.resumo-top{
			display:grid;
			grid-template-columns:repeat(3,1fr);
			gap:20px;
			}
			.resumo-bottom{
			display:grid;
			grid-template-columns:repeat(4,1fr);
			gap:16px;
			}
			.resumo-top div,
			.resumo-bottom div{
			background:#020617;
			padding:18px;
			border-radius:10px;
			text-align:center;
			}
			/* cards menores */
			.resumo-bottom .valor{
			font-size:18px;
			}
			/* ---------- Assinatura ---------- */
			.assinatura {
			position: fixed;
			bottom: 18px;
			right: 22px;
			text-align: right;
			font-size: 14px;
			letter-spacing: 0.6px;
			user-select: none;
			opacity: 0.95;
			}
			.assinatura strong {
			color: #b56bff;
			font-weight: 700;
			text-shadow:
			0 0 6px rgba(181, 107, 255, 0.7),
			0 0 16px rgba(155, 70, 255, 0.5),
			0 0 28px rgba(120, 40, 220, 0.35);
			}
			.assinatura span {
			display: block;
			font-size: 11px;
			color: #d6b8ff;
			margin-top: 2px;
			text-shadow: 0 0 5px rgba(181, 107, 255, 0.5);
			}
			.assinatura:hover strong {
			text-shadow:
			0 0 10px rgba(200, 140, 255, 1),
			0 0 25px rgba(170, 90, 255, 0.9),
			0 0 45px rgba(120, 40, 220, 0.8);
			}
			.backup-bar{
			display:flex;
			justify-content:space-between;
			align-items:center;
			gap:12px;
			background:linear-gradient(135deg,#020617,#0f172a);
			padding:14px 18px;
			border-radius:14px;
			margin:12px 0 25px;
			border:1px solid #1f2933;
			}
			.backup-status{
			font-size:14px;
			display:flex;
			align-items:center;
			gap:8px;
			color:#c7d2fe;
			}
			.backup-status strong{
			color:#93c5fd;
			}
			.backup-status::before{
			content:"üïí";
			filter:drop-shadow(0 0 6px rgba(59,130,246,.7));
			}
			.backup-actions{
			display:flex;
			gap:10px;
			}
			.backup-actions button{
			background:linear-gradient(135deg,#3b82f6,#2563eb);
			border-radius:10px;
			padding:8px 14px;
			font-size:14px;
			box-shadow:0 0 12px rgba(59,130,246,.4);
			}
			td[style*="n√£o informado"]{
			color:#94a3b8;
			font-style:italic;
			}
			.metaBar{
			background:#020617;
			height:6px;
			border-radius:5px;
			overflow:hidden;
			}
			.metaBar div{
			background:#22c55e;
			height:100%;
			transition:.4s;
			}
		</style>
	</head>
	<body>
		<h1>Controle de Ganhos</h1>
		<div class="container">
			<div class="card header">
				<strong>Ano:</strong>
				<select id="ano" onchange="trocarAno()"></select>
			</div>
			<div class="backup-bar">
				<div class="backup-status" id="statusBackup"></div>
				<div class="backup-actions">
					<button onclick="exportarBackup()">üì¶ Backup</button>
					<input type="file" id="importFile" accept=".json" hidden onchange="importarBackup(event)">
					<button onclick="document.getElementById('importFile').click()">üì• Importar</button>
				</div>
			</div>
			<div class="card">
				<!-- TOPO: 3 cards grandes -->
				<div class="resumo-top">
					<div>
						Total Anual
						<div class="valor" id="totalAnual">R$0</div>
					</div>
					<div>
						Ano Anterior
						<div class="valor" id="totalAnterior">R$0</div>
					</div>
					<div>
						Diferen√ßa
						<div class="valor" id="diferenca">R$0</div>
					</div>
				</div>
				<br>
				<!-- BAIXO: 4 cards pequenos -->
				<div class="resumo-bottom">
					<div>
						SAL√ÅRIO
						<div class="valor" id="total_salario">R$0</div>
					</div>
					<div>
						PETZ
						<div class="valor" id="total_petz">R$0</div>
					</div>
					<div>
						AMAZON
						<div class="valor" id="total_amazon">R$0</div>
					</div>
					<div>
						EPSEG
						<div class="valor" id="total_epseg">R$0</div>
					</div>
				</div>
			</div>
			<div class="card">
				<div class="tabs">
					<div class="tab active" onclick="trocarAba(0)">Sal√°rio</div>
					<div class="tab" onclick="trocarAba(1)">PETZ</div>
					<div class="tab" onclick="trocarAba(2)">AMAZON</div>
					<div class="tab" onclick="trocarAba(3)">EPSEG</div>
				</div>
				<div id="salario" class="content active"></div>
				<div id="petz" class="content"></div>
				<div id="amazon" class="content"></div>
				<div id="epseg" class="content"></div>
			</div>
			<div class="card">
				<h3 id="tituloComparativo"></h3>
				<div id="comparativoMensal"></div>
			</div>
			<div class="card" style="margin-top:20px">
			  <h3 style="margin-bottom:10px">üìä Previs√£o Inteligente do Ano</h3>
			
			  <div style="
			    background:linear-gradient(135deg,#020617,#0f172a);
			    border:1px solid #1f2933;
			    border-radius:14px;
			    padding:18px;
			    text-align:center;
			  ">
			    <div style="font-size:13px;color:#93c5fd;letter-spacing:.6px">
			      Baseada na m√©dia atual e no ano anterior
			    </div>
			
			    <div id="previsao" style="
			      margin-top:10px;
			      font-size:28px;
			      font-weight:700;
			      color:#22c55e;
			      text-shadow:0 0 14px rgba(34,197,94,.5)
			    ">
			      R$ 0,00
			    </div>
			  </div>
			</div>
			</div>
			<div class="card">
				<canvas id="graficoAnual"></canvas>
			</div>
		</div>
		<div class="toast" id="toast">‚úî Dados salvos</div>
		<!-- Firebase -->
		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
			import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
			
			const firebaseConfig = {
			  apiKey: "AIzaSyDQcM-q2jwZMshHnuf-jRfaxeYSmsjNCUs",
			  authDomain: "controle-ganhos-6ec22.firebaseapp.com",
			  projectId: "controle-ganhos-6ec22",
			  storageBucket: "controle-ganhos-6ec22.firebasestorage.app",
			  messagingSenderId: "590231444558",
			  appId: "1:590231444558:web:2417aa6044f2a86e18371f"
			};
			
			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);
			
			window.db = db;
			window.doc = doc;
			window.setDoc = setDoc;
			window.getDoc = getDoc;
		</script>
		<script>
			let metaMensal = 3500;
			let dadosFirebase = {};
			const meses=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
			const abas=["salario","petz","amazon","epseg"];
			let grafico;
			let trocandoAno = false;
			
			function criarTabela(id){
			let html="<table><tr><th>M√™s</th><th>Valor</th></tr>";
			meses.forEach((m,i)=>{
			html+=`<tr class="${i===new Date().getMonth()?'mes-atual':''}">
			<td>${m}</td>
			<input data-id="${id}_${i}" onfocus="salvarCampo(this)" onblur="formatarMoeda(this); salvarDados(this)" oninput="lerInputsTempoReal()">
			</tr>`;
			});
			html+="</table>";
			document.getElementById(id).innerHTML=html;
			}
			abas.forEach(criarTabela);
			
			async function lerInputsTempoReal(){
			  let dados = {};
			  abas.forEach(a=>{
			    dados[a] = meses.map((_,i)=>{
			      let el = document.querySelector(`[data-id='${a}_${i}']`);
			      return Number(el.value.replace(/[^\d]/g,""))/100 || 0;
			    });
			  });
			
			  dadosFirebase = dados;
			
			  // Passa os dadosFirebase para atualizarTudo
			  await atualizarTudo(dadosFirebase);
			  // Checa queda instant√¢nea
			  await checarQueda(); // compara com ano anterior
			}
			function formatarMoeda(el){
			let v=parseFloat(el.value.replace(/[^\d]/g,""))/100||0;
			el.value=v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
			}
			
			function salvarCampo(el){
			localStorage.setItem("ultimoCampo",el.dataset.id);
			}
			function salvarAno(){
			    localStorage.setItem("anoSelecionado", document.getElementById("ano").value);
			}
			async function trocarAno(){
			
			  trocandoAno = true;
			
			  salvarAno();
			
			  await carregarDados();   // ‚¨Ö espera Firebase terminar
			
			  trocandoAno = false;
			}
			
			async function salvarDados(el) {
			  if (trocandoAno) return;
			
			  const ano = anoSel();
			  let dados = {};
			
			  abas.forEach(a => {
			    dados[a] = meses.map((_, i) => {
			      let input = document.querySelector(`[data-id='${a}_${i}']`);
			      return Number(input.value.replace(/[^\d]/g, "")) / 100 || 0;
			    });
			  });
			
			  dadosFirebase = dados;
			
			  await setDoc(doc(db, "ganhos", String(ano)), dados);
			
			  atualizarTudo();
			  toast();
			
			  // checa queda **apenas para o m√™s alterado**
			  if(el){
			    const parts = el.dataset.id.split("_");
			    const aba = parts[0];
			    const mes = Number(parts[1]);
			    checarQueda(ano, mes);
			  }
			}
			
			async function carregarDados(){
			    const ano = anoSel();
			    const snap = await getDoc(doc(db,"ganhos",String(ano))); 
			    const dadosAnoAtual = snap.exists() ? snap.data() : {};
			
			    // carrega dados nas tabelas
			    abas.forEach(a=>{
			        meses.forEach((_,i)=>{
			            let el = document.querySelector(`[data-id='${a}_${i}']`);
			            if(el) el.value = (dadosAnoAtual[a]?.[i] || 0)
			                .toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
			        });
			    });
			
			    restaurarCampo();
			
			    // chama atualizarTudo passando dados explicitamente
			    await atualizarTudo(dadosAnoAtual);
			}

			async function checarQueda(ano, mesAlterado) {
			  const atual = abas.reduce((s, a) => s + (dadosFirebase[a]?.[mesAlterado] || 0), 0);
			  if (atual === 0) return;
			
			  const anoAnterior = ano - 1;
			  const snap = await getDoc(doc(db, "ganhos", String(anoAnterior)));
			  const dadosAnt = snap.exists() ? snap.data() : {};
			
			  const anterior = abas.reduce((s, a) => s + (dadosAnt[a]?.[mesAlterado] || 0), 0);
			  if (anterior === 0) return;
			
			  const queda = ((atual - anterior) / anterior) * 100;
			
			  if (queda <= -20) {
			    alert(`‚ö†Ô∏è Aten√ß√£o! Seu rendimento caiu mais de 20% comparado ao mesmo m√™s do ano passado (${meses[mesAlterado]})`);
			  }
			}

			function progressoMes(i){
			  const vals = totais();
			  let p = (vals[i] / metaMensal) * 100;
			  return Math.min(100, Math.max(0, p));
			}
			async function previsaoAnualComparativa(){
			  const vals = totais().filter(v => v > 0);
			  if(vals.length === 0) return 0;
			
			  const media = vals.reduce((a,b)=>a+b,0) / vals.length;
			  const projAtual = media * 12;
			
			  const anoAnterior = anoSel() - 1;
			  const snap = await getDoc(doc(db,"ganhos",String(anoAnterior)));
			  const dadosAnt = snap.exists() ? snap.data() : {};
			
			  const totalAnt = meses.reduce((t,_,i)=>
			    t + abas.reduce((s,a)=>s+(dadosAnt[a]?.[i]||0),0)
			  ,0);
			
			  return Math.max(projAtual, totalAnt);
			}

			async function atualizarTudo(dadosAtual){
			    const ano = anoSel();
			    const ant = ano - 1;
			
			    dadosFirebase = dadosAtual; // atualiza global apenas depois
			
			    // total anual
				animar("totalAnual", totalAno()); 
			
			    // previs√£o anual
			    const prev = await previsaoAnualComparativa();
			    document.getElementById("previsao").innerText =
			        prev.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
			
			    // dados ano anterior
			    const snapAnt = await getDoc(doc(db,"ganhos",String(ant)));
			    const dadosAnt = snapAnt.exists() ? snapAnt.data() : {};
			    const totalAnt = meses.reduce((t,_,i)=>
			        t + abas.reduce((s,a)=>s+(dadosAnt[a]?.[i]||0),0),0
			    );
				animar("totalAnterior", totalAnt);
			    animar("diferenca", totalAno() - totalAnt);
			
			    gerarComparativo(ano,ant,dadosAtual,dadosAnt);
			
			    animar("total_salario", totalPorAba("salario"));
			    animar("total_petz", totalPorAba("petz"));
			    animar("total_amazon", totalPorAba("amazon"));
			    animar("total_epseg", totalPorAba("epseg"));
			
			    await checarQueda();
			}
			
			function animar(id,valor){
			let el=document.getElementById(id),i=0;
			const step=valor/30;
			const timer=setInterval(()=>{
			i+=step;
			if(Math.abs(i)>=Math.abs(valor)){i=valor;clearInterval(timer)}
			el.innerText=i.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
			},20);
			}
			
			async function gerarComparativo(ano, ant, dadosAtual, dadosAnt){
			    let atual = meses.map((_,i)=>abas.reduce((s,a)=>s+(dadosAtual[a]?.[i]||0),0));
			    let antigo = meses.map((_,i)=>abas.reduce((s,a)=>s+(dadosAnt[a]?.[i]||0),0));
			
			    let totalAtual = atual.reduce((a,b)=>a+b,0);
			    let totalAntigo = antigo.reduce((a,b)=>a+b,0);
			
			    let diffAno = totalAtual - totalAntigo;
			    let percAno = totalAntigo ? (diffAno / totalAntigo * 100) : 0;
			
			    document.getElementById("tituloComparativo").innerHTML = `
			        ${ant} ‚Üí ${ano} | 
			        Diferen√ßa anual: 
			        <strong style="color:${diffAno>=0?'#22c55e':'#ef4444'}">
			          ${diffAno.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
			          (${percAno.toFixed(1)}%)
			        </strong>
			    `;
			
			    let max = Math.max(...atual.filter(v=>v>0), 0);
			    let html = `<table>
			        <tr>
			          <th>M√™s</th>
			          <th>${ant}</th>
			          <th>${ano}</th>
			          <th>Œî R$</th>
			          <th>%</th>
			          <th>Tend√™ncia</th>
			        </tr>`;
			
			    meses.forEach((m,i)=>{
			        if(atual[i] === 0){
			            html += `<tr class="heat-0">
			                <td>${m}</td>
			                <td>${antigo[i].toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
			                <td style="opacity:.5">‚Äî n√£o informado ‚Äî</td>
			                <td>‚Äî</td>
			                <td>‚Äî</td>
			                <td>‚è≥</td>
			            </tr>`;
			            return;
			        }
			
			        let diff = atual[i] - antigo[i];
			        let perc = antigo[i] ? (diff/antigo[i]*100) : 0;
			        let heat = max ? Math.min(4, Math.floor((atual[i]/max)*4)) : 0;
			        let seta = diff > 0 ? "üìà" : diff < 0 ? "üìâ" : "‚ûñ";
			        let prog = progressoMes(i);
			
			        html += `<tr class="heat-${heat}">
			            <td>${m}</td>
			            <td>${antigo[i].toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
			            <td>
			                ${atual[i].toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
			                <div class="metaBar"><div style="width:${prog}%"></div></div>
			            </td>
			            <td style="color:${diff>=0?'#22c55e':'#ef4444'}">
			                ${diff.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
			            </td>
			            <td>${perc.toFixed(1)}%</td>
			            <td>${seta}</td>
			        </tr>`;
			    });
			
			    html += "</table>";
			    document.getElementById("comparativoMensal").innerHTML = html;
			}
			
			function totais(){
			  return meses.map((_,i)=>
			    abas.reduce((s,a)=>s+(dadosFirebase[a]?.[i]||0),0)
			  );
			}
			
			function totalAno(){
			  return totais().reduce((x,y)=>x+y,0);
			}
			
			function totalPorAba(aba){
			  return (dadosFirebase[aba] || []).reduce((s,v)=>s+v,0);
			}
			function anoSel(){return Number(document.getElementById("ano").value);}
			
			function toast(){
			const t=document.getElementById("toast");
			t.classList.add("show");
			setTimeout(()=>t.classList.remove("show"),1200);
			}
			
			function restaurarCampo(){
			    if (trocandoAno) return; 
			
			    const id = localStorage.getItem("ultimoCampo");
			    if(id){
			        const el = document.querySelector(`[data-id='${id}']`);
			        if(el) el.focus();
			    }
			}
			
			function trocarAba(i){
			document.querySelectorAll(".tab").forEach((t,x)=>t.classList.toggle("active",x===i));
			document.querySelectorAll(".content").forEach((c,x)=>c.classList.toggle("active",x===i));
			localStorage.setItem("abaAtiva",i);
			}
			
			// restaura ANO primeiro
			const anoSalvo = localStorage.getItem("anoSelecionado");
			if (anoSalvo) {
			    document.getElementById("ano").value = anoSalvo;
			}
			
			// restaura ABA depois
			const abaSalva = localStorage.getItem("abaAtiva");
			if (abaSalva !== null) {
			    trocarAba(Number(abaSalva));
			}
			
			function atualizarStatusBackup(){
			  const info = localStorage.getItem("ultimoBackup");
			  const el = document.getElementById("statusBackup");
			
			  if(info && info !== "null"){
			    el.innerHTML = `√öltimo backup: <strong>${info}</strong>`;
			  }else{
			    el.innerHTML = `‚ö† Nenhum backup foi realizado ainda`;
			  }
			}
			async function exportarBackup(){
			  const pacote = {};
			  const anos = Array.from({length:5},(_,i)=>2025+i); // gera 2025,2026,2027,2028,2029
			
			  for(const ano of anos){
			    const snap = await getDoc(doc(db,"ganhos",String(ano)));
			    pacote[ano] = snap.exists() ? snap.data() : {};
			  }
			
			  const blob = new Blob(
			    [JSON.stringify({
			      data: new Date().toLocaleString("pt-BR"),
			      ganhos: pacote
			    },null,2)],
			    {type:"application/json"}
			  );
			  const agora = new Date().toLocaleString("pt-BR");
			  localStorage.setItem("ultimoBackup", agora);
			  atualizarStatusBackup();
			  const a = document.createElement("a");
			  a.href = URL.createObjectURL(blob);
			  a.download = `backup-completo.json`;
			  a.click();
			}
			async function importarBackup(e){
			  const file = e.target.files[0];
			  if(!file) return;
			
			  const reader = new FileReader();
			  reader.onload = async () => {
			    const pacote = JSON.parse(reader.result);
			
			    for(const ano in pacote.ganhos){
			      await setDoc(
			        doc(db,"ganhos",ano),
			        pacote.ganhos[ano]
			      );
			    }
			
				await carregarDados();
				
				const agora = new Date().toLocaleString("pt-BR");
				localStorage.setItem("ultimoBackup", agora);
				atualizarStatusBackup();
				
				alert("Backup restaurado com sucesso!");
			  };
			
			  reader.readAsText(file);
			}
			window.addEventListener("load", async () => {
			
			    const selectAno = document.getElementById("ano");
			    const anos = Array.from({length:5}, (_, i) => 2025 + i); // gera 2025,2026,2027,2028,2029
			    anos.forEach(ano => {
			        const option = document.createElement("option");
			        option.value = ano;
			        option.textContent = ano;
			        selectAno.appendChild(option);
			    });
			
			    // restaura o ano salvo, se houver
			    const anoSalvo = localStorage.getItem("anoSelecionado");
			    if (anoSalvo) selectAno.value = anoSalvo;
			
			    const abaSalva = localStorage.getItem("abaAtiva");
			    if (abaSalva !== null) {
			        trocarAba(Number(abaSalva));
			    }
			
			    await carregarDados();   // ‚¨Ö espera Firebase terminar
			    atualizarStatusBackup(); 
			});

		</script>
		<div class="assinatura">
			<strong>by hiro v2.0</strong>
			<span>financial dashboard</span>
		</div>
	</body>
</html>
